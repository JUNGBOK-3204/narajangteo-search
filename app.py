import os
import time
import requests
import xml.etree.ElementTree as ET
import streamlit as st
import pandas as pd
from io import BytesIO
from datetime import datetime, timedelta
from openpyxl.utils import get_column_letter
from openpyxl.styles import Alignment, Border, Side, PatternFill, Font

# ==========================================
# 1. API í‚¤ ë° ê²€ìƒ‰ ê¸°ë¡ ê´€ë¦¬ ê¸°ëŠ¥ 
# ==========================================
HISTORY_FILE = "search_history.txt" [cite: 1]

def load_api_key(): [cite: 1]
    """ì„¸ì…˜ì— ì €ì¥ëœ í‚¤ë¥¼ ìš°ì„  í™•ì¸í•˜ê³ , ì—†ìœ¼ë©´ ë¹ˆ ê°’ì„ ë°˜í™˜í•©ë‹ˆë‹¤.""" [cite: 1]
    if 'user_api_key' in st.session_state: [cite: 1]
        return st.session_state['user_api_key'] [cite: 1]
    return "" [cite: 1]

def save_api_key(key): [cite: 1]
    """ì…ë ¥ë°›ì€ í‚¤ë¥¼ í˜„ì¬ ì‚¬ìš©ìì˜ ì„¸ì…˜ì— ì €ì¥í•©ë‹ˆë‹¤.""" [cite: 1]
    st.session_state['user_api_key'] = key.strip() [cite: 1]

def load_history(): [cite: 1]
    if os.path.exists(HISTORY_FILE): [cite: 1]
        try: [cite: 1]
            with open(HISTORY_FILE, "r", encoding="utf-8") as f: [cite: 1]
                return [line.strip() for line in f.readlines() if line.strip()] [cite: 1]
        except: return [] [cite: 1]
    return [] [cite: 1]

def add_history(record): [cite: 1]
    history = load_history() [cite: 1]
    history.insert(0, record) [cite: 1]
    history = history[:5] [cite: 1]
    try: [cite: 1]
        with open(HISTORY_FILE, "w", encoding="utf-8") as f: [cite: 1]
            for item in history: [cite: 1]
                f.write(f"{item}\n") [cite: 1]
    except: pass [cite: 1]

# ==========================================
# 2. ë‚˜ë¼ì¥í„° API ìˆ˜ì§‘ í•¨ìˆ˜ 
# ==========================================
ORDER_PLAN_URL = "https://apis.data.go.kr/1230000/ao/OrderPlanSttusService/getOrderPlanSttusListServcPPSSrch" [cite: 1]
PRIOR_SPEC_URL = "https://apis.data.go.kr/1230000/ao/HrcspSsstndrdInfoService/getPublicPrcureThngInfoServcPPSSrch" [cite: 1]
BID_NOTICE_URL = "https://apis.data.go.kr/1230000/ad/BidPublicInfoService/getBidPblancListInfoServcPPSSrch" [cite: 1]

def fetch_data_from_api(url, params): [cite: 1]
    all_items = [] [cite: 1]
    page = 1 [cite: 1]
    while True: [cite: 1]
        params["pageNo"] = str(page) [cite: 1]
        params["numOfRows"] = "500" [cite: 1]
        try: [cite: 1]
            response = requests.get(url, params=params, timeout=60) [cite: 1]
            if response.status_code != 200: break [cite: 1]
            root = ET.fromstring(response.text) [cite: 1]
            items = root.findall(".//items/item") [cite: 1]
            if not items: break [cite: 1]
            for item in items: [cite: 1]
                row_data = {child.tag: (child.text or "").strip() for child in list(item)} [cite: 1]
                all_items.append(row_data) [cite: 1]
            total_count_elem = root.find(".//body/totalCount") [cite: 1]
            if total_count_elem is not None: [cite: 1]
                if len(all_items) >= int(total_count_elem.text): break [cite: 1]
            page += 1 [cite: 1]
        except: break [cite: 1]
    return all_items [cite: 1]

def fetch_bid_data_split(service_key, keywords, months=12, progress_callback=None): [cite: 1]
    all_results = [] [cite: 1]
    now = datetime.now() [cite: 1]
    for i in range(months): [cite: 1]
        start_date = now - timedelta(days=(i + 1) * 30) [cite: 1]
        end_date = now - timedelta(days=i * 30) [cite: 1]
        bgn_str = start_date.strftime("%Y%m%d%H%M") [cite: 1]
        end_str = end_date.strftime("%Y%m%d%H%M") [cite: 1]
        for kw in keywords: [cite: 1]
            p = {"serviceKey": service_key, "type": "xml", "inqryDiv": "1", [cite: 1]
                 "inqryBgnDt": bgn_str, "inqryEndDt": end_str, "bidNtceNm": kw} [cite: 1]
            all_results.extend(fetch_data_from_api(BID_NOTICE_URL, p)) [cite: 1]
        if progress_callback: [cite: 1]
            progress_callback(i + 1, months) [cite: 1]
        time.sleep(0.1) [cite: 1]
    return all_results [cite: 1]

# ==========================================
# 3. ë°ì´í„° ê°€ê³µ í•¨ìˆ˜ 
# ==========================================
def get_val(row, possible_keys, default=''): [cite: 1]
    row_lower = {k.lower(): v for k, v in row.items()} [cite: 1]
    for k in possible_keys: [cite: 1]
        if k in row and pd.notna(row[k]) and str(row[k]).strip() != '': [cite: 1]
            return str(row[k]).strip() [cite: 1]
        k_lower = k.lower() [cite: 1]
        if k_lower in row_lower and pd.notna(row_lower[k_lower]) and str(row_lower[k_lower]).strip() != '': [cite: 1]
            return str(row_lower[k_lower]).strip() [cite: 1]
    return default [cite: 1]

def get_clean_val(row, possible_keys): [cite: 1]
    val = get_val(row, possible_keys) [cite: 1]
    return val if val else "" [cite: 1]

def apply_exclusion_filter(df, target_col, exclude_keywords): [cite: 1]
    if df.empty or not exclude_keywords: [cite: 1]
        return df [cite: 1]
    mask = df[target_col].apply(lambda x: not any(exc in str(x) for exc in exclude_keywords)) [cite: 1]
    return df[mask] [cite: 1]

def process_order_for_excel(df, exclude_keywords=[]): [cite: 1]
    if df is None or df.empty: return pd.DataFrame() [cite: 1]
    new_df = pd.DataFrame() [cite: 1]
    new_df['ìš©ì—­êµ¬ë¶„'] = df.apply(lambda r: 'ì¼ë°˜ìš©ì—­' if get_val(r, ['bsnsDivCd'])=='03' else ('ê¸°ìˆ ìš©ì—­' if get_val(r, ['bsnsDivCd'])=='05' else ''), axis=1) [cite: 1]
    new_df['ì—…ë¬´êµ¬ë¶„'] = df.apply(lambda r: get_val(r, ['bsnsTyNm', 'bztyNm']), axis=1) [cite: 1]
    new_df['ë°œì£¼ì‹œê¸°'] = df.apply(lambda r: f"{get_val(r,['orderYear'])}/{get_val(r,['orderMnth']).zfill(2)}" if get_val(r,['orderYear']) else '', axis=1) [cite: 1]
    new_df['ì‚¬ì—…ëª…'] = df.apply(lambda r: get_clean_val(r, ['bizNm', 'prdctClsfNoNm', 'prdctClsfcNoNm', 'cntrctNm']), axis=1) [cite: 1]
    new_df['ì´ë°œì£¼ê¸ˆì•¡(ì›)'] = df.apply(lambda r: int(float(get_val(r, ['sumOrderAmt', 'totlAmt'], '0').replace(',',''))), axis=1) [cite: 1]
    new_df['ë°œì£¼ê¸°ê´€ëª…'] = df.apply(lambda r: get_clean_val(r, ['orderInsttNm', 'dmndInsttNm', 'realOrgNm']), axis=1) [cite: 1]
    new_df['ê²Œì‹œì¼ì'] = df.apply(lambda r: get_val(r, ['nticeDt', 'opengDt']), axis=1) [cite: 1]
    new_df = new_df[new_df['ì‚¬ì—…ëª…'].str.strip() != ''].copy() [cite: 1]
    if exclude_keywords: [cite: 1]
        new_df = apply_exclusion_filter(new_df, 'ì‚¬ì—…ëª…', exclude_keywords) [cite: 1]
    if 'ë°œì£¼ì‹œê¸°' in new_df.columns: [cite: 1]
        new_df.sort_values(by='ë°œì£¼ì‹œê¸°', ascending=True, inplace=True) [cite: 1]
    new_df.reset_index(drop=True, inplace=True) [cite: 1]
    new_df.insert(0, 'No.', range(1, len(new_df) + 1)) [cite: 1]
    return new_df [cite: 1]

def process_prior_for_excel(df, exclude_keywords=[]): [cite: 1]
    if df is None or df.empty: return pd.DataFrame() [cite: 1]
    col_map = { [cite: 1]
        'bsnsDivNm': 'ì—…ë¬´êµ¬ë¶„', 'refNo': 'ì°¸ì¡°ë²ˆí˜¸', 'prdctClsfcNoNm': 'ì‚¬ì—…ëª…(í’ˆëª…)', [cite: 1]
        'orderInsttNm': 'ê³µê³ ê¸°ê´€', 'rlDminsttNm': 'ì‹¤ìˆ˜ìš”ê¸°ê´€', 'asignBdgtAmt': 'ë°°ì •ì˜ˆì‚°ì•¡(ì›)', [cite: 1]
        'rcptDt': 'ê³µê°œì¼ì‹œ', 'opninRgstClseDt': 'ì˜ê²¬ë“±ë¡ë§ˆê°ì¼ì‹œ', 'ofclNm': 'ë‹´ë‹¹ìëª…', [cite: 1]
        'ofclTelNo': 'ë‹´ë‹¹ìì „í™”ë²ˆí˜¸', 'swBizObjYn': 'SWì‚¬ì—…ì—¬ë¶€', 'dlvrTmlmtDt': 'ë‚©í’ˆê¸°í•œ', [cite: 1]
        'dlvrDaynum': 'ë‚©í’ˆì¼ìˆ˜', 'bfSpecRgstNo': 'ì‚¬ì „ê·œê²©ë“±ë¡ë²ˆí˜¸', 'specDocFileUrl1': 'ê·œê²©ì„œURL', [cite: 1]
        'rgstDt': 'ë“±ë¡ì¼ì‹œ', 'chgDt': 'ë³€ê²½ì¼ì‹œ', 'bidNtceNoList': 'ë³¸ê³µê³ ë²ˆí˜¸(ì—°ê³„)' [cite: 1]
    } [cite: 1]
    new_df = pd.DataFrame() [cite: 1]
    def parse_money(x): [cite: 1]
        try: return int(float(str(x).replace(',', '').strip())) [cite: 1]
        except: return 0 [cite: 1]
    for tag, kr_col in col_map.items(): [cite: 1]
        found_col = None [cite: 1]
        for col in df.columns: [cite: 1]
            if col.lower() == tag.lower(): [cite: 1]
                found_col = col [cite: 1]
                break [cite: 1]
        if tag == 'asignBdgtAmt': [cite: 1]
            new_df[kr_col] = df[found_col].apply(parse_money) if found_col else 0 [cite: 1]
        else: [cite: 1]
            new_df[kr_col] = df[found_col].fillna("") if found_col else "" [cite: 1]
    new_df = new_df[new_df['ì‚¬ì—…ëª…(í’ˆëª…)'].str.strip() != ''].copy() [cite: 1]
    if exclude_keywords: [cite: 1]
        new_df = apply_exclusion_filter(new_df, 'ì‚¬ì—…ëª…(í’ˆëª…)', exclude_keywords) [cite: 1]
    if 'ê³µê°œì¼ì‹œ' in new_df.columns: [cite: 1]
        new_df.sort_values(by='ê³µê°œì¼ì‹œ', ascending=True, inplace=True) [cite: 1]
    new_df.reset_index(drop=True, inplace=True) [cite: 1]
    new_df.insert(0, 'No.', range(1, len(new_df) + 1)) [cite: 1]
    return new_df [cite: 1]

def process_bid_for_excel(df, exclude_keywords=[]): [cite: 1]
    if df is None or df.empty: return pd.DataFrame() [cite: 1]
    col_map = { [cite: 1]
        'bidNtceNo': 'ê³µê³ ë²ˆí˜¸', 'bidNtceOrd': 'ì°¨ìˆ˜', 'reNtceYn': 'ì¬ê³µê³ ì—¬ë¶€', 'bidNtceNm': 'ê³µê³ ëª…', [cite: 1]
        'ntceKindNm': 'ê³µê³ ì¢…ë¥˜', 'bidMethdNm': 'ì…ì°°ë°©ì‹', 'cntrctCnclsMthdNm': 'ê³„ì•½ë°©ë²•', [cite: 1]
        'sucsfbidMthdNm': 'ë‚™ì°°ìê²°ì •ë°©ë²•', 'ntceInsttNm': 'ê³µê³ ê¸°ê´€', 'dminsttNm': 'ìˆ˜ìš”ê¸°ê´€', [cite: 1]
        'ntceInsttOfclNm': 'ë‹´ë‹¹ìëª…', 'ntceInsttOfclTelNo': 'ë‹´ë‹¹ìì „í™”ë²ˆí˜¸', 'bidNtceDt': 'ê²Œì‹œì¼ì‹œ', [cite: 1]
        'bidBeginDt': 'ì…ì°°ê°œì‹œì¼ì‹œ', 'bidClseDt': 'ì…ì°°ë§ˆê°ì¼ì‹œ', 'opengDt': 'ê°œì°°ì¼ì‹œ', [cite: 1]
        'bidQlfctRgstDt': 'ì…ì°°ì°¸ê°€ìê²©ë“±ë¡ë§ˆê°ì¼ì‹œ', 'asignBdgtAmt': 'ë°°ì •ì˜ˆì‚°(ì›)', [cite: 1]
        'presmptPrce': 'ì¶”ì •ê°€ê²©(ì›)', 'bidPrtcptFee': 'ì…ì°°ì°¸ê°€ìˆ˜ìˆ˜ë£Œ', 'bidNtceUrl': 'ê³µê³ ë§í¬(URL)', [cite: 1]
        'bfSpecRgstNo': 'ì‚¬ì „ê·œê²©ë“±ë¡ë²ˆí˜¸', 'refNo': 'ì°¸ì¡°ë²ˆí˜¸', 'cmmnSpldmdMethdNm': 'ê³µë™ìˆ˜ê¸‰ì—¬ë¶€', [cite: 1]
        'prearngPrceDcsnMthdNm': 'ì˜ˆê°€ë°©ì‹', 'opengPlce': 'ê°œì°°ì¥ì†Œ', 'brffcBidprcPermsnYn': 'ì§€ì‚¬íˆ¬ì°°í—ˆìš©ì—¬ë¶€' [cite: 1]
    } [cite: 1]
    new_df = pd.DataFrame() [cite: 1]
    def parse_money(x): [cite: 1]
        try: return int(float(str(x).replace(',', '').strip())) [cite: 1]
        except: return 0 [cite: 1]
    for tag, kr_col in col_map.items(): [cite: 1]
        found_col = None [cite: 1]
        for col in df.columns: [cite: 1]
            if col.lower() == tag.lower(): [cite: 1]
                found_col = col [cite: 1]
                break [cite: 1]
        if tag in ['asignBdgtAmt', 'presmptPrce', 'bidPrtcptFee']: [cite: 1]
            new_df[kr_col] = df[found_col].apply(parse_money) if found_col else 0 [cite: 1]
        else: [cite: 1]
            new_df[kr_col] = df[found_col].fillna("") if found_col else "" [cite: 1]
    def calc_min_bid(row): [cite: 1]
        budget = row['ë°°ì •ì˜ˆì‚°(ì›)'] [cite: 1]
        estim = row['ì¶”ì •ê°€ê²©(ì›)'] [cite: 1]
        base_price = budget if budget > 0 else estim [cite: 1]
        if base_price > 0: return int(base_price * 0.87745) [cite: 1]
        return 0 [cite: 1]
    new_df['ì˜ˆìƒ íˆ¬ì°°í•˜í•œê°€(ì›)'] = new_df.apply(calc_min_bid, axis=1) [cite: 1]
    new_df = new_df[new_df['ê³µê³ ëª…'].str.strip() != ''].copy() [cite: 1]
    if exclude_keywords: [cite: 1]
        new_df = apply_exclusion_filter(new_df, 'ê³µê³ ëª…', exclude_keywords) [cite: 1]
    if 'ê²Œì‹œì¼ì‹œ' in new_df.columns: [cite: 1]
        new_df.sort_values(by='ê²Œì‹œì¼ì‹œ', ascending=True, inplace=True) [cite: 1]
    new_df.reset_index(drop=True, inplace=True) [cite: 1]
    new_df.insert(0, 'No.', range(1, len(new_df) + 1)) [cite: 1]
    return new_df [cite: 1]

# ==========================================
# 4. ì—‘ì…€ ì„œì‹í™” 
# ==========================================
def convert_df_to_excel(df_order, df_prior, df_bid): [cite: 1]
    output = BytesIO() [cite: 1]
    with pd.ExcelWriter(output, engine='openpyxl') as writer: [cite: 1]
        align_rules = { [cite: 1]
            'ë°œì£¼ê³„íš': {'left': ['ì‚¬ì—…ëª…', 'ë°œì£¼ê¸°ê´€ëª…'], 'right': ['ì´ë°œì£¼ê¸ˆì•¡(ì›)']}, [cite: 1]
            'ì‚¬ì „ê·œê²©ê³µê°œ': {'left': ['ì‚¬ì—…ëª…(í’ˆëª…)', 'ê³µê³ ê¸°ê´€', 'ì‹¤ìˆ˜ìš”ê¸°ê´€'], 'right': ['ë°°ì •ì˜ˆì‚°ì•¡(ì›)']}, [cite: 1]
            'ì…ì°°ê³µê³ ': {'left': ['ê³µê³ ëª…', 'ê³µê³ ê¸°ê´€', 'ìˆ˜ìš”ê¸°ê´€'], 'right': ['ë°°ì •ì˜ˆì‚°(ì›)', 'ì¶”ì •ê°€ê²©(ì›)', 'ì…ì°°ì°¸ê°€ìˆ˜ìˆ˜ë£Œ', 'ì˜ˆìƒ íˆ¬ì°°í•˜í•œê°€(ì›)']} [cite: 1]
        } [cite: 1]
        custom_widths = {'ë°œì£¼ê³„íš': {'ì‚¬ì—…ëª…': 60}, 'ì‚¬ì „ê·œê²©ê³µê°œ': {'ì‚¬ì—…ëª…(í’ˆëª…)': 60}, 'ì…ì°°ê³µê³ ': {'ê³µê³ ëª…': 60, 'ê°œì°°ì¥ì†Œ': 32}} [cite: 1]
        header_fill = PatternFill(start_color="E7E6E6", end_color="E7E6E6", fill_type="solid") [cite: 1]
        urgent_font = Font(color="FF0000", bold=True) [cite: 1]
        link_font = Font(color="0000FF", underline="single") [cite: 1]
        yellow_fill = PatternFill(start_color="FFFF00", end_color="FFFF00", fill_type="solid") [cite: 1]
        now = datetime.now() [cite: 1]

        def apply_styles(df, sheet_name): [cite: 1]
            if df is None: return [cite: 1]
            if df.empty: [cite: 1]
                pd.DataFrame({'ê²°ê³¼': ['ì¡°ê±´ì— ë§ëŠ” ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.']}).to_excel(writer, index=False, sheet_name=sheet_name) [cite: 1]
                return [cite: 1]
            df.to_excel(writer, index=False, sheet_name=sheet_name) [cite: 1]
            ws = writer.sheets[sheet_name] [cite: 1]
            ws.auto_filter.ref = ws.dimensions [cite: 1]
            money_cols = ['ì´ë°œì£¼ê¸ˆì•¡(ì›)', 'ë°°ì •ì˜ˆì‚°ì•¡(ì›)', 'ë°°ì •ì˜ˆì‚°(ì›)', 'ì¶”ì •ê°€ê²©(ì›)', 'ì…ì°°ì°¸ê°€ìˆ˜ìˆ˜ë£Œ', 'ì˜ˆìƒ íˆ¬ì°°í•˜í•œê°€(ì›)'] [cite: 1]
            rules = align_rules.get(sheet_name, {'left': [], 'right': []}) [cite: 1]
            wide_cols = rules['left'] [cite: 1]
            sheet_custom_widths = custom_widths.get(sheet_name, {}) [cite: 1]
            header_map = {} [cite: 1]
            deadline_col_idx = -1 [cite: 1]
            for idx, cell in enumerate(ws[1]): [cite: 1]
                header_map[cell.column] = cell.value [cite: 1]
                if cell.value == 'ì…ì°°ë§ˆê°ì¼ì‹œ': deadline_col_idx = idx [cite: 1]

            for column in ws.columns: [cite: 1]
                column_letter = get_column_letter(column[0].column) [cite: 1]
                col_name = header_map.get(column[0].column) [cite: 1]
                if col_name in sheet_custom_widths: [cite: 1]
                    ws.column_dimensions[column_letter].width = sheet_custom_widths[col_name] [cite: 1]
                    continue [cite: 1]
                max_length = 0 [cite: 1]
                for cell in column: [cite: 1]
                    try: [cite: 1]
                        if cell.value: [cite: 1]
                            cell_len = len(str(cell.value)) [cite: 1]
                            if cell_len > max_length: max_length = cell_len [cite: 1]
                    except: pass [cite: 1]
                adjusted_width = (max_length + 7) * 1.4 if col_name in wide_cols else (max_length + 5) * 1.3 [cite: 1]
                if adjusted_width > 120: adjusted_width = 120 [cite: 1]
                ws.column_dimensions[column_letter].width = adjusted_width [cite: 1]

            for row in ws.iter_rows(min_row=2): [cite: 1]
                is_urgent = False [cite: 1]
                if deadline_col_idx != -1: [cite: 1]
                    try: [cite: 1]
                        cell_val = row[deadline_col_idx].value [cite: 1]
                        if cell_val: [cite: 1]
                            deadline = pd.to_datetime(str(cell_val)) [cite: 1]
                            if (deadline - now).days <= 7 and (deadline > now): is_urgent = True [cite: 1]
                    except: pass [cite: 1]
                for cell in row: [cite: 1]
                    cell.border = Border(left=Side(style='thin'), right=Side(style='thin'), top=Side(style='thin'), bottom=Side(style='thin')) [cite: 1]
                    col_name = header_map.get(cell.column) [cite: 1]
                    if col_name in money_cols and isinstance(cell.value, (int, float)): cell.number_format = '#,##0' [cite: 1]
                    if col_name in rules['left']: cell.alignment = Alignment(horizontal='left', vertical='center', indent=1) [cite: 1]
                    elif col_name in rules['right']: cell.alignment = Alignment(horizontal='right', vertical='center', indent=1) [cite: 1]
                    else: cell.alignment = Alignment(horizontal='center', vertical='center') [cite: 1]
                    if is_urgent: [cite: 1]
                        cell.font = urgent_font [cite: 1]
                        cell.fill = yellow_fill [cite: 1]
                    if col_name in ['ê·œê²©ì„œURL', 'ê³µê³ ë§í¬(URL)'] and cell.value: [cite: 1]
                        val = str(cell.value) [cite: 1]
                        if val.startswith("http"): [cite: 1]
                            cell.hyperlink = val [cite: 1]
                            cell.font = link_font [cite: 1]
                            if is_urgent: cell.fill = yellow_fill [cite: 1]

            for cell in ws[1]: [cite: 1]
                cell.alignment = Alignment(horizontal='center', vertical='center') [cite: 1]
                cell.fill = header_fill [cite: 1]
                cell.border = Border(left=Side(style='thin'), right=Side(style='thin'), top=Side(style='thin'), bottom=Side(style='thin')) [cite: 1]

        apply_styles(df_order, 'ë°œì£¼ê³„íš') [cite: 1]
        apply_styles(df_prior, 'ì‚¬ì „ê·œê²©ê³µê°œ') [cite: 1]
        apply_styles(df_bid, 'ì…ì°°ê³µê³ ') [cite: 1]
    return output.getvalue() [cite: 1]

# ==========================================
# 5. UI ë° ë©”ì¸ ë¡œì§ 
# ==========================================
st.set_page_config(page_title="ë‚˜ë¼ì¥í„° ê²€ìƒ‰ ì‹œìŠ¤í…œ", layout="wide") [cite: 1]

if 'df_order' not in st.session_state: st.session_state.df_order = None [cite: 1]
if 'df_prior' not in st.session_state: st.session_state.df_prior = None [cite: 1]
if 'df_bid' not in st.session_state: st.session_state.df_bid = None [cite: 1]

LOGO_FILENAME = "radsol_logo.png" [cite: 1]
col1, col2, col3, col4 = st.columns([1, 6, 1.5, 1.5]) [cite: 1]
with col1: [cite: 1]
    if os.path.exists(LOGO_FILENAME): st.image(LOGO_FILENAME, use_container_width=True) [cite: 1]
with col2: [cite: 1]
    st.markdown("""
        # ë‚˜ë¼ì¥í„° ìš©ì—­&ì…ì°° ê²€ìƒ‰ ì‹œìŠ¤í…œ <span style='font-size: 0.5em; color: #cccccc;'>v0.1 &nbsp;&nbsp; by ì—°êµ¬ê´€ë¦¬íŒ€</span>
        <div style='margin-top: 5px;'>
            <span style='font-size: 15px; color: red; font-weight: bold;'>â€» ë³¸ í”„ë¡œê·¸ë¨ì˜ ê²€ìƒ‰ ê²°ê³¼ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì¤‘ìš”í•œ ë°ì´í„°ëŠ” ê¼­ ë‚˜ë¼ì¥í„° í™ˆí˜ì´ì§€ë¥¼ í™•ì¸í•  ê²ƒ!</span>
        </div>
        """, unsafe_allow_html=True) [cite: 1]
with col3: [cite: 1]
    st.markdown("<div style='margin-top: 22px;'></div>", unsafe_allow_html=True) [cite: 1]
    search_clicked = st.button("ğŸ” ì¡°íšŒ ì‹œì‘", use_container_width=True) [cite: 1]
with col4: [cite: 1]
    st.markdown("<div style='margin-top: 22px;'></div>", unsafe_allow_html=True) [cite: 1]
    download_container = st.empty() [cite: 1]

with st.sidebar: [cite: 1]
    st.header("âš™ï¸ ê²€ìƒ‰ ì„¤ì •") [cite: 1]
    
    saved_key = load_api_key() [cite: 1]
    with st.expander("ğŸ” ë‚´ API Key ì„¤ì •", expanded=(not saved_key)): [cite: 1]
        service_key_input = st.text_input("ê³µê³µë°ì´í„°í¬í„¸ ì¸ì¦í‚¤", value=saved_key, type="password", help="ë³¸ì¸ì˜ ê°œì¸ ì¸ì¦í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì´ í‚¤ëŠ” ì„¸ì…˜ì´ ìœ ì§€ë˜ëŠ” ë™ì•ˆì—ë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.") [cite: 1]
        if st.button("ì¸ì¦í‚¤ ì ìš©í•˜ê¸°"): [cite: 1]
            if service_key_input: [cite: 1]
                save_api_key(service_key_input) [cite: 1]
                st.success("ì¸ì¦í‚¤ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!") [cite: 1]
                st.rerun() [cite: 1]
    
    service_key = load_api_key() [cite: 1]
    
    if service_key: [cite: 1]
        st.caption("âœ… ì¸ì¦í‚¤ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.") [cite: 1]
    else: [cite: 1]
        st.error("â›” ì¡°íšŒë¥¼ ìœ„í•´ API ì¸ì¦í‚¤ ì…ë ¥ì´ í•„ìš”í•©ë‹ˆë‹¤.") [cite: 1]

    st.divider() [cite: 1]
    st.subheader("ğŸ“‹ ì¡°íšŒ ëŒ€ìƒ ì„ íƒ") [cite: 1]
    # ğŸ¨ ë¬¸êµ¬ ìœ„ì¹˜ë¥¼ ì†Œì œëª© ë°”ë¡œ ì•„ë˜ë¡œ ì´ë™ 
    st.markdown("<div style='color: #666666; font-size: 15px; font-weight: bold; margin-top: -10px; margin-bottom: 10px;'>(ì¼ë°˜/ê¸°ìˆ ìš©ì—­ë§Œ ì¡°íšŒí•¨)</div>", unsafe_allow_html=True) [cite: 1]
    
    check_order = st.checkbox("ë°œì£¼ê³„íš", value=True) [cite: 1]
    check_prior = st.checkbox("ì‚¬ì „ê·œê²©ê³µê°œ", value=True) [cite: 1]
    check_bid = st.checkbox("ì…ì°°ê³µê³ ", value=True) [cite: 1]
    
    st.divider() [cite: 1]

    keywords_input = st.text_input("ğŸ”‘ í‚¤ì›Œë“œ (ì‰¼í‘œë¡œ êµ¬ë¶„)", value="ë°©ì‚¬ëŠ¥") [cite: 1]
    keywords = [k.strip() for k in keywords_input.split(",") if k.strip()] [cite: 1]
    exclude_input = st.text_input("ğŸš« ì œì™¸ í‚¤ì›Œë“œ", value="ìœ ì§€ë³´ìˆ˜, X-ray") [cite: 1]
    exclude_keywords = [k.strip() for k in exclude_input.split(",") if k.strip()] [cite: 1]
    
    st.divider() [cite: 1]
    year = int(st.number_input("ì¡°íšŒ ì—°ë„ ì„¤ì •", min_value=2000, value=2026)) [cite: 1]
    bid_months = st.slider("ì…ì°°ê³µê³  ìˆ˜ì§‘ ê¸°ê°„ (ìµœê·¼ Nê°œì›”)", 1, 12, 3) [cite: 1]
    
    st.divider() [cite: 1]
    history_container = st.empty() [cite: 1]
    def update_history_ui(): [cite: 1]
        with history_container.container(): [cite: 1]
            st.subheader("ğŸ•’ ìµœê·¼ ì¡°íšŒ (ê³µìš©)") [cite: 1]
            for h in load_history(): st.caption(f"â€¢ {h}") [cite: 1]
    update_history_ui() [cite: 1]

if search_clicked: [cite: 1]
    if not service_key: [cite: 1]
        st.warning("ë¨¼ì € ì‚¬ì´ë“œë°”ì—ì„œ API ì¸ì¦í‚¤ë¥¼ ì…ë ¥í•˜ê³  [ì ìš©í•˜ê¸°]ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.") [cite: 1]
    else: [cite: 1]
        st.session_state.df_order = None [cite: 1]
        st.session_state.df_prior = None [cite: 1]
        st.session_state.df_bid = None [cite: 1]
        prog_bar = st.progress(0, text="ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘...") [cite: 1]
        inqry_bgn, inqry_end = f"{year}01010000", f"{year}12312359" [cite: 1]
        total_kw = len(keywords) [cite: 1]
        
        if check_order or check_prior: [cite: 1]
            all_o, all_p = [], [] [cite: 1]
            for idx, kw in enumerate(keywords): [cite: 1]
                current_progress = int(40 * (idx + 1) / (total_kw if total_kw > 0 else 1)) [cite: 1]
                prog_bar.progress(current_progress, text=f"ğŸ” ê³µê³  ì¡°íšŒ ì¤‘... ({kw})") [cite: 1]
                if check_order: [cite: 1]
                    for cd in ["03", "05"]: [cite: 1]
                        all_o.extend(fetch_data_from_api(ORDER_PLAN_URL, {"serviceKey": service_key, "type": "xml", "inqryBgnDt": inqry_bgn, "inqryEndDt": inqry_end, "orderBgnYm": f"{year-1}12", "orderEndYm": f"{year}12", "bsnsDivCd": cd, "bizNm": kw})) [cite: 1]
                if check_prior: [cite: 1]
                    all_p.extend(fetch_data_from_api(PRIOR_SPEC_URL, {"serviceKey": service_key, "type": "xml", "inqryDiv": "1", "inqryBgnDt": inqry_bgn, "inqryEndDt": inqry_end, "prdctClsfcNoNm": kw})) [cite: 1]
            if check_order: st.session_state.df_order = process_order_for_excel(pd.DataFrame(all_o).drop_duplicates(), exclude_keywords) [cite: 1]
            if check_prior: st.session_state.df_prior = process_prior_for_excel(pd.DataFrame(all_p).drop_duplicates(), exclude_keywords) [cite: 1]

        if check_bid: [cite: 1]
            def bid_progress_update(current, total): [cite: 1]
                percent = 40 + int(60 * (current / total)) [cite: 1]
                prog_bar.progress(min(percent, 100), text=f"ğŸ“¥ ì…ì°°ê³µê³  ìˆ˜ì§‘ ì¤‘... ({current}/{total}ê°œì›”)") [cite: 1]
            all_b = fetch_bid_data_split(service_key, keywords, months=bid_months, progress_callback=bid_progress_update) [cite: 1]
            st.session_state.df_bid = process_bid_for_excel(pd.DataFrame(all_b).drop_duplicates(), exclude_keywords) [cite: 1]
        
        prog_bar.progress(100, text="âœ… ì™„ë£Œ!") [cite: 1]
        time.sleep(0.5); prog_bar.empty() [cite: 1]
        
        cnt_o = len(st.session_state.df_order) if st.session_state.df_order is not None else 0 [cite: 1]
        cnt_p = len(st.session_state.df_prior) if st.session_state.df_prior is not None else 0 [cite: 1]
        cnt_b = len(st.session_state.df_bid) if st.session_state.df_bid is not None else 0 [cite: 1]
        st.success(f"âœ… ì¡°íšŒê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! [ ë°œì£¼: {cnt_o}ê±´ / ì‚¬ì „: {cnt_p}ê±´ / ì…ì°°: {cnt_b}ê±´ ]") [cite: 1]

        add_history(f"{datetime.now().strftime('%m/%d %H:%M:%S')} ({keywords_input})") [cite: 1]
        update_history_ui() [cite: 1]

if any(x is not None for x in [st.session_state.df_order, st.session_state.df_prior, st.session_state.df_bid]): [cite: 1]
    xl_data = convert_df_to_excel(st.session_state.df_order, st.session_state.df_prior, st.session_state.df_bid) [cite: 1]
    download_container.download_button(label="ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ", data=xl_data, file_name=f"ë‚˜ë¼ì¥í„° ì¡°íšŒ_{datetime.now().strftime('%Y%m%d')}.xlsx", use_container_width=True) [cite: 1]
    
    tabs_labels = [] [cite: 1]
    if st.session_state.df_order is not None: tabs_labels.append("ğŸ“Š ë°œì£¼ê³„íš") [cite: 1]
    if st.session_state.df_prior is not None: tabs_labels.append("ğŸ“ ì‚¬ì „ê·œê²©ê³µê°œ") [cite: 1]
    if st.session_state.df_bid is not None: tabs_labels.append("ğŸ”” ì…ì°°ê³µê³ ") [cite: 1]
    
    if tabs_labels: [cite: 1]
        tabs = st.tabs(tabs_labels) [cite: 1]
        curr = 0 [cite: 1]
        if st.session_state.df_order is not None: [cite: 1]
            with tabs[curr]: [cite: 1]
                df_v = st.session_state.df_order.copy() [cite: 1]
                if not df_v.empty: df_v['ì´ë°œì£¼ê¸ˆì•¡(ì›)'] = df_v['ì´ë°œì£¼ê¸ˆì•¡(ì›)'].apply(lambda x: f"{x:,}") [cite: 1]
                st.dataframe(df_v, use_container_width=True, hide_index=True, height=600) [cite: 1]
            curr += 1 [cite: 1]
        if st.session_state.df_prior is not None: [cite: 1]
            with tabs[curr]: [cite: 1]
                df_p = st.session_state.df_prior.copy() [cite: 1]
                if not df_p.empty: df_p['ë°°ì •ì˜ˆì‚°ì•¡(ì›)'] = df_p['ë°°ì •ì˜ˆì‚°ì•¡(ì›)'].apply(lambda x: f"{x:,}" if x > 0 else "") [cite: 1]
                st.dataframe(df_p, use_container_width=True, hide_index=True, height=600, column_config={"ê·œê²©ì„œURL": st.column_config.LinkColumn("ê·œê²©ì„œ", display_text="ğŸ”— ë‹¤ìš´ë¡œë“œ")}) [cite: 1]
            curr += 1 [cite: 1]
        if st.session_state.df_bid is not None: [cite: 1]
            with tabs[curr]: [cite: 1]
                df_b = st.session_state.df_bid.copy() [cite: 1]
                for col in ['ë°°ì •ì˜ˆì‚°(ì›)', 'ì¶”ì •ê°€ê²©(ì›)', 'ì…ì°°ì°¸ê°€ìˆ˜ìˆ˜ë£Œ', 'ì˜ˆìƒ íˆ¬ì°°í•˜í•œê°€(ì›)']: [cite: 1]
                    if not df_b.empty and col in df_b.columns: df_b[col] = df_b[col].apply(lambda x: f"{x:,}" if x > 0 else "") [cite: 1]
                st.dataframe(df_b, use_container_width=True, hide_index=True, height=600, column_config={"ê³µê³ ë§í¬(URL)": st.column_config.LinkColumn("ì›ë¬¸ ë§í¬", display_text="ğŸ”— ê³µê³ ì´ë™")}) [cite: 1]
